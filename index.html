<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard — Live Test</title>
  <style>
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:18px;background:#071024;color:#e6eef6}
    .wrap{max-width:1100px;margin:0 auto}
    .card{background:#0b1220;padding:14px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.6)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    button{background:#06b6d4;border:none;padding:8px 10px;border-radius:8px;color:#04283a;font-weight:700;cursor:pointer}
    button.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#94a3b8}
    input,select{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:rgba(255,255,255,0.02);color:inherit}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left}
    thead th{position:sticky;top:0;background:linear-gradient(180deg,#071224,#08182a);z-index:2}
    .muted{color:#94a3b8;font-size:13px}
    .right{margin-left:auto;display:flex;gap:8px}
    #log{margin-top:10px;font-size:13px;color:#cde}
    .pill{padding:4px 8px;border-radius:999px;font-weight:700;font-size:12px}
    .admin-badge{background:#bbf7d0;color:#064e3b;padding:6px 10px;border-radius:8px}
    .overlay{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,0.6)}
    .modal{background:#0b1520;padding:16px;border-radius:10px;min-width:320px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h2 style="margin:0">Dashboard Program — (Live)</h2>
        <div class="muted">Uji sambungan ke Google Apps Script — baca/tambah/kemaskini.</div>
      </div>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="who" class="muted">Guest</div>
        <div class="right">
          <button id="btnRefresh" class="ghost">Muat Semula</button>
          <button id="btnAddNew">Tambah</button>
          <button id="btnLogin" class="ghost">Log Masuk</button>
        </div>
      </div>
    </header>

    <div class="card">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
        <input id="search" placeholder="Cari aktiviti / tempat..." style="flex:1" />
        <select id="filterLajnah"><option value="">-- Semua Lajnah --</option></select>
        <select id="filterBulan"><option value="">-- Semua Bulan --</option></select>
        <button id="btnClear" class="ghost">Reset</button>
      </div>

      <div id="tableWrap">
        <table id="tbl">
          <thead><tr id="theadRow"></tr></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="emptyMsg" class="muted" style="display:none;padding:12px">Tiada rekod untuk dipaparkan.</div>

      <div id="log" class="muted">Log: ready</div>
    </div>
  </div>

  <!-- form modal -->
  <div id="modal" class="overlay" style="display:none">
    <div class="modal">
      <h3 id="modalTitle">Tambah / Edit</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
        <input id="m_bil" placeholder="BIL" />
        <input id="m_program" placeholder="Aktiviti / Program" />
        <input id="m_tarikh" placeholder="Tarikh (dd/mm/yyyy)" />
        <input id="m_tempat" placeholder="Tempat" />
        <input id="m_lajnah" placeholder="Lajnah / Jabatan" />
        <input id="m_bulan" placeholder="Bulan" />
        <input id="m_kos" placeholder="Kos (RM)" />
      </div>
      <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:10px">
        <button id="m_cancel" class="ghost">Batal</button>
        <button id="m_save">Simpan</button>
      </div>
    </div>
  </div>

  <!-- login modal -->
  <div id="loginModal" class="overlay" style="display:none">
    <div class="modal">
      <h3>Log Masuk Admin</h3>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <input id="li_id" placeholder="ID" />
        <input id="li_pw" placeholder="Password" type="password" />
        <div style="display:flex;gap:8px;justify-content:flex-end">
          <button id="li_cancel" class="ghost">Batal</button>
          <button id="li_ok">Log Masuk</button>
        </div>
        <div id="li_err" class="muted" style="color:#fca5a5;display:none"></div>
      </div>
    </div>
  </div>

<script>
/* ====== CONFIG ====== */
const API_URL = 'https://script.google.com/macros/s/AKfycbx0vXghbmsoA-XT9odtwGemRtOXqo4oMeQdkhdJeDlLQ6tVnWNZ3r7nImO28aUIZB-uNw/exechttps://script.google.com/macros/s/AKfycbxBe-Nx5uh5xGomOuEzf9XmP-qoz0rTsAHldhVleoOviSVJT4NWcahj0DyFb-Anz0DMNQ/exec';
/* ====== END CONFIG ====== */

let RAW = [];        // raw rows from server
let DATA = [];       // normalized objects {bil, program, tarikh, tempat, lajnah, bulan, kos}
let editIndex = -1;
let isAdmin = false;

/* ---------- UTIL ---------- */
function log(msg){ document.getElementById('log').innerText = 'Log: ' + msg; console.log('[DASH]', msg); }
function show(el){ el.style.display='block'; }
function hide(el){ el.style.display='none'; }
function toNum(v){ const n=Number(String(v).replace(/,/g,'')); return isNaN(n)?0:n; }

/* Normalize server row to object
   Accepts:
   - object with keys (bil, program, tarikh, tempat, lajnah, bulan, kos) OR
   - array (row) where columns correspond to [bil, program, tarikh, tempat, lajnah, bulan, kos] OR
   - object with other header names (attempt to map)
*/
function normalizeRow(raw){
  if(!raw) return null;
  // object-like with keys
  if(typeof raw === 'object' && !Array.isArray(raw)){
    const keys = Object.keys(raw).map(k=>k.toLowerCase());
    // common key detection
    const pick = (candidates) => {
      for(const cand of candidates){
        const idx = keys.indexOf(cand.toLowerCase());
        if(idx !== -1) return raw[Object.keys(raw)[idx]];
      }
      return undefined;
    };
    return {
      bil: pick(['bil','no','no.']) ?? raw.BIL ?? raw.Bil ?? '',
      program: pick(['aktiviti/program','aktiviti','program']) ?? raw['AKTIVITI/PROGRAM'] ?? raw['AKTIVITI'] ?? '',
      tarikh: pick(['tarikh','date']) ?? raw.TARIKH ?? '',
      tempat: pick(['tempat','venue']) ?? raw.TEMPAT ?? '',
      lajnah: pick(['lajnah/jabatan','lajnah','jabatan']) ?? raw['LAJNAH/JABATAN'] ?? '',
      bulan: pick(['bulan','month']) ?? raw.BULAN ?? '',
      kos: pick(['kos','cost']) ?? raw.KOS ?? 0
    };
  }
  // array-like
  if(Array.isArray(raw)){
    return {
      bil: raw[0] ?? '',
      program: raw[1] ?? '',
      tarikh: raw[2] ?? '',
      tempat: raw[3] ?? '',
      lajnah: raw[4] ?? '',
      bulan: raw[5] ?? '',
      kos: raw[6] ?? 0
    };
  }
  return null;
}

/* ---------- RENDER ---------- */
function renderTable(){
  const tbody = document.getElementById('tbody');
  tbody.innerHTML = '';
  const theadRow = document.getElementById('theadRow');
  theadRow.innerHTML = '';
  // build header
  const headers = ['BIL','AKTIVITI / PROGRAM','TARIKH','TEMPAT','LAJNAH / JABATAN','BULAN','KOS','ACTION'];
  headers.forEach(h=>{
    const th = document.createElement('th'); th.innerText=h; theadRow.appendChild(th);
  });

  if(DATA.length === 0){ show(document.getElementById('emptyMsg')); return; }
  hide(document.getElementById('emptyMsg'));

  DATA.forEach((r, i) => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.bil ?? ''}</td>
      <td>${r.program ?? ''}</td>
      <td>${r.tarikh ?? ''}</td>
      <td>${r.tempat ?? ''}</td>
      <td>${r.lajnah ?? ''}</td>
      <td>${r.bulan ?? ''}</td>
      <td style="text-align:right">${r.kos ?? ''}</td>
      <td></td>
    `;
    const actionTd = tr.querySelector('td:last-child');
    if(isAdmin){
      const editBtn = document.createElement('button'); editBtn.className='ghost'; editBtn.innerText='Edit';
      editBtn.onclick = ()=> openModalForEdit(i);
      const delBtn = document.createElement('button'); delBtn.className='ghost'; delBtn.innerText='Padam';
      delBtn.onclick = ()=> doDelete(i);
      actionTd.appendChild(editBtn); actionTd.appendChild(document.createTextNode(' ')); actionTd.appendChild(delBtn);
    } else {
      const lock = document.createElement('span'); lock.className='muted'; lock.innerText='—';
      actionTd.appendChild(lock);
    }
    tbody.appendChild(tr);
  });
}

/* ---------- FETCH DATA ---------- */
async function loadData(){
  log('Memuat data dari server...');
  try{
    const res = await fetch(API_URL + (API_URL.includes('?') ? '&' : '?') + 'action=read', {cache:'no-store'});
    const text = await res.text();
    let json;
    try{ json = JSON.parse(text); } catch(e){ json = text; }
    console.log('RAW RESPONSE:', json);

    let rows = [];
    // possible shapes:
    // 1) { success:true, data:[ {..}, {...} ] }
    if(json && typeof json === 'object' && Array.isArray(json.data)) rows = json.data;
    // 2) array of objects or arrays
    else if(Array.isArray(json)) rows = json;
    // 3) maybe { success:true, result: [...] }
    else if(json && typeof json === 'object' && Array.isArray(json.result)) rows = json.result;
    else{
      log('Tindak balas tak difahami, periksa console.');
      console.warn('Unknown response:', json);
      rows = [];
    }

    // normalize
    RAW = rows;
    DATA = rows.map(r => normalizeRow(r)).filter(x=>x !== null);
    log('Data dimuat: ' + DATA.length + ' baris.');
    renderTable();
    buildFilters();
  } catch(err){
    console.error('loadData error', err);
    log('Gagal muat data: ' + err.message);
  }
}

/* ---------- FILTERS ---------- */
function buildFilters(){
  const lajEl = document.getElementById('filterLajnah');
  const bulEl = document.getElementById('filterBulan');
  const laj = [...new Set(DATA.map(r => (r.lajnah || '').toString().trim()).filter(x=>x))].sort();
  const bul = [...new Set(DATA.map(r => (r.bulan || '').toString().trim()).filter(x=>x))].sort();
  lajEl.innerHTML = '<option value="">-- Semua Lajnah --</option>' + laj.map(x=>`<option value="${x}">${x}</option>`).join('');
  bulEl.innerHTML = '<option value="">-- Semua Bulan --</option>' + bul.map(x=>`<option value="${x}">${x}</option>`).join('');
}
function applyFilters(){
  const q = document.getElementById('search').value.toLowerCase().trim();
  const fl = document.getElementById('filterLajnah').value;
  const fb = document.getElementById('filterBulan').value;
  const filtered = DATA.filter(r=>{
    if(fl && (r.lajnah||'') !== fl) return false;
    if(fb && (r.bulan||'') !== fb) return false;
    if(q){
      const hay = ((r.program||'') + ' ' + (r.tempat||'') + ' ' + (r.lajnah||'') + ' ' + (r.bulan||'')).toLowerCase();
      if(!hay.includes(q)) return false;
    }
    return true;
  });
  // render filtered
  const prev = DATA;
  DATA = filtered;
  renderTable();
  DATA = prev; // restore original after render
}

/* ---------- MODAL / ADD / EDIT ---------- */
function openModalForAdd(){
  editIndex = -1;
  document.getElementById('modalTitle').innerText = 'Tambah Program';
  clearModalFields();
  show(document.getElementById('modal'));
}
function openModalForEdit(i){
  editIndex = i;
  const r = DATA[i];
  document.getElementById('modalTitle').innerText = 'Kemaskini Program';
  document.getElementById('m_bil').value = r.bil ?? '';
  document.getElementById('m_program').value = r.program ?? '';
  document.getElementById('m_tarikh').value = r.tarikh ?? '';
  document.getElementById('m_tempat').value = r.tempat ?? '';
  document.getElementById('m_lajnah').value = r.lajnah ?? '';
  document.getElementById('m_bulan').value = r.bulan ?? '';
  document.getElementById('m_kos').value = r.kos ?? '';
  show(document.getElementById('modal'));
}
function clearModalFields(){
  ['m_bil','m_program','m_tarikh','m_tempat','m_lajnah','m_bulan','m_kos'].forEach(id=>document.getElementById(id).value='');
}
document.getElementById('m_cancel').addEventListener('click', ()=>hide(document.getElementById('modal')));

document.getElementById('m_save').addEventListener('click', async ()=>{
  const record = {
    bil: document.getElementById('m_bil').value || '',
    program: document.getElementById('m_program').value || '',
    tarikh: document.getElementById('m_tarikh').value || '',
    tempat: document.getElementById('m_tempat').value || '',
    lajnah: document.getElementById('m_lajnah').value || '',
    bulan: document.getElementById('m_bulan').value || '',
    kos: document.getElementById('m_kos').value || 0
  };
  if(!record.program){ alert('Sila isi nama aktiviti'); return; }
  hide(document.getElementById('modal'));
  if(editIndex >= 0){
    // update
    try{
      log('Menghantar kemaskini ke server...');
      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action: 'update', record })
      });
      const j = await resp.json().catch(()=>({}));
      console.log('UPDATE RESPONSE', j);
      if(j && j.success) { log('Kemas kini berjaya'); }
      else log('Respon server: ' + (j.message || JSON.stringify(j)));
    }catch(e){ console.error(e); log('Gagal kemaskini: ' + e.message); }
  } else {
    // add
    try{
      log('Menghantar tambah ke server...');
      const resp = await fetch(API_URL, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action: 'add', record })
      });
      const j = await resp.json().catch(()=>({}));
      console.log('ADD RESPONSE', j);
      if(j && j.success) { log('Tambah berjaya'); }
      else log('Respon server: ' + (j.message || JSON.stringify(j)));
    }catch(e){ console.error(e); log('Gagal tambah: ' + e.message); }
  }
  // reload data after slight delay
  setTimeout(loadData, 700);
});

/* ---------- DELETE ---------- */
async function doDelete(i){
  if(!confirm('Padam rekod ini?')) return;
  const row = DATA[i];
  try{
    log('Hantar permintaan padam...');
    const resp = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'delete', record: { bil: row.bil } })
    });
    const j = await resp.json().catch(()=>({}));
    console.log('DELETE RESPONSE', j);
    if(j && j.success) log('Padam berjaya');
    else log('Respon server: ' + (j.message || JSON.stringify(j)));
  }catch(e){ console.error(e); log('Gagal padam: ' + e.message); }
  setTimeout(loadData, 700);
}

/* ---------- LOGIN ---------- */
document.getElementById('btnLogin').addEventListener('click', ()=> show(document.getElementById('loginModal')));
document.getElementById('li_cancel').addEventListener('click', ()=> hide(document.getElementById('loginModal')));
document.getElementById('li_ok').addEventListener('click', ()=> {
  const id = document.getElementById('li_id').value.trim();
  const pw = document.getElementById('li_pw').value.trim();
  if(id === 'qamar' && pw === 'qamar'){
    isAdmin = true;
    localStorage.setItem('isAdmin','1');
    updateUIForAuth();
    hide(document.getElementById('loginModal'));
    log('Login admin berjaya');
    loadData();
  } else {
    document.getElementById('li_err').style.display='block';
    document.getElementById('li_err').innerText='ID / password salah';
  }
});
function updateUIForAuth(){
  document.getElementById('who').innerText = isAdmin ? 'Admin (qamar)' : 'Guest';
  document.getElementById('btnLogin').style.display = isAdmin ? 'none' : 'inline-block';
  if(isAdmin){
    const btnLogout = document.getElementById('btnLogout');
    if(!btnLogout){
      const b = document.createElement('button'); b.id='btnLogout'; b.className='ghost'; b.innerText='Logout';
      b.onclick = ()=>{ isAdmin=false; localStorage.removeItem('isAdmin'); updateUIForAuth(); loadData(); log('Logout'); };
      document.querySelector('.right').appendChild(b);
    } else btnLogout.style.display='inline-block';
  }
}

/* ---------- Hooks ---------- */
document.getElementById('btnRefresh').addEventListener('click', ()=> loadData());
document.getElementById('btnAddNew').addEventListener('click', ()=> {
  if(!isAdmin){ if(!confirm('Anda belum login sebagai Admin. Terus tambah sebagai User (rekod akan Menunggu Kelulusan)?')) return; }
  openModalForAdd();
});
document.getElementById('btnClear').addEventListener('click', ()=> { document.getElementById('search').value=''; document.getElementById('filterLajnah').value=''; document.getElementById('filterBulan').value=''; applyFilters(); });
document.getElementById('search').addEventListener('input', applyFilters);
document.getElementById('filterLajnah').addEventListener('change', applyFilters);
document.getElementById('filterBulan').addEventListener('change', applyFilters);

/* ---------- Init ---------- */
(function init(){
  if(localStorage.getItem('isAdmin')) isAdmin = true;
  updateUIForAuth();
  loadData();
})();
</script>
</body>
</html>
